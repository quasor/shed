<% unless @tasks.empty? %>
<div id="leftcol" class="resizeable">
		<div class="st">
			<div style="height:21px;border-top:1px solid white"><b><%= link_to "Filtered - Show All Tasks", root_path, {:style=>'color:#E98C44'} unless params[:p].blank? && params[:u].blank?%></b>
				<%= @task_intervals%>
				</div>
			<%#= render :partial => 'tasklist', :locals => {:skip_completed => nil}%>
			<%= render :partial => 'task', :collection => @tasks%>
		</div>

</div>
<div id="rightcol" onscroll="scrollDiv('leftcol','rightcol')">
		<table class="st" id="schedule">
		<thead>
			<tr class="srow2">
				<td>Section</td>
		    <td colspan="2">Estimate</td>
<!--
		    <td>Sim</td> 
-->
		    <td>Owner</td>
		    <td>Start</td>
		    <td>End</td>
			  <td>
						<div style="position:relative; margin-left:0px">				
							<% @milestones = Release.all.collect(&:due)%>
							<% for i in 0..@total_calendar_days-%>
							<% d = Date.today + i -%>
							<div style="position:absolute;top:1em;left:<%= @day_in_pixels * i %>px;height:<%= @tasks.size * 2.5%>em;width:<%=@day_in_pixels-1%>px;<% if d.wday == 0 || d.wday == 6 %>background-color:#777;opacity:0.5;<% elsif @milestones.include? d%>border-right:2px dotted #900;<%end %>border-left:1px solid #ccc;"><span style="position:absolute;top:-1.5em;left:-<%=1%>px;z-index:10;font-weight:normal;font-size:11px;padding-left:2px; border-left:1px solid #ccc"><%= d.strftime('%m/%d') if d.wday == 1%></span></div>
							<% end -%>
						</div>
				</td>
			</tr>
	  </thead>
		<% for task in @tasks %>
		<% if (params[:p].blank? || task.parent_id == params[:p].to_i) && 
			(params[:u].blank? || task.user_id == params[:u].to_i) || !task.type.nil?%>
		
	  <tr class="srow">
				<% unless task.type == "Release" or task.type == "Project"%>
			    <td nowrap><%=h task.tag_list %></td>
			    <td nowrap><%=h task.estimate %><%= "d" unless task.estimate.include? ?h or task.estimate.include? ?d or task.estimate.blank?%></td>
			    <td><%=link_to task.estimate_days.round(3), edit_task_path(task) %></td>
					<!-- <td><%=h task.monte_estimate.round(2) unless task.low.nil?%></td> -->
			    <td nowrap><%=task.user ? (link_to task.user.name, :u => task.user.id) : '<span class="unassigned">Unassigned</span>'%></td>
			    <td><nobr><%=h task.start unless task.completed?%></nobr></td>
			    <td><nobr><%=h task.end unless task.completed?%> <% unless params[:xray].blank? || task.best_start.nil? %>[<%=task.best_start%> - <%=task.worst_end%>]<% end %></nobr></td>

					<td style="width:<%=@day_in_pixels * @total_calendar_days %>px;vertical-align:top">
						<% unless task.completed? || task.start.nil? || task.end.nil? %>
						<div style="position:relative; width:<%= @day_in_pixels*@total_calendar_days %>px;">							
							<span title="<%= task.start.to_s(:long) %> - <%= task.end.to_date.to_s(:long) %> (<%= task.estimate_days %>days)" class="ganttbar" 
								style="width:<%= @day_in_pixels * (task.end.to_date - task.start.to_date) %>px; left:<%= @day_in_pixels * (task.start - Date.today) %>px"></span>					
								<% unless params[:xray].blank? || task.best_start.nil?%><span class="ganttbar_r" 
									style="width:<%= @day_in_pixels * (task.worst_end - task.best_start) %>px; left:<%= @day_in_pixels * (task.best_start - Date.today) %>px"></span>
								<% end %>					
						</div>
						<% end %>
					</td>
			    <td><%= link_to 'E', edit_task_path(task) %></td>
					<td><%= link_to 'X', task, :confirm => "About to delete #{task.title}\n\nAre you sure you wish to delete this task?\n", :method => :delete%></td>
				<%else # Releases and Projects:%>
				<td colspan="6"><nobr>
					Due <%= task.due_date %>  
					<% unless task.projections.nil? || task.projections.empty?%>
					<% start_p = task.projections.rollup.last.start %>
					<% end_p = task.projections.rollup.last.end %>
						<b>ETA: <%= start_p%>  - <%= end_p %></b>
					<% end %>
					</nobr></td>
					<% unless task.projections.nil? || task.projections.empty?%>
					<td style="width:<%=@day_in_pixels * @total_calendar_days %>px;vertical-align:top">
						<% unless task.completed? || start_p.nil? || end_p.nil? %>
						<div style="position:relative; width:<%= @day_in_pixels*@total_calendar_days %>px;">							
							<span class="ganttbar_s" style="width:<%= @day_in_pixels * (start_p - Date.today) %>px; left:<%= @day_in_pixels * (0) %>px"></span>					
							<span class="ganttbar_p" style="width:<%= @day_in_pixels * (end_p - start_p) %>px; left:<%= @day_in_pixels * (start_p - Date.today) %>px"></span>					
						</div>
						<% end %>
					</td>
					<% end %>
				<% end %>
		  </tr>
		<% end %>
		<% end %>
	<% if false %>
			<tr>
				<td colspan="5"></td>
		    <td><%=  @tasks.collect(&:estimate).sum %></td>
		    <td><%= @durations[@durations.size * 0.05].round(3)%> - <%= @durations[@durations.size * 0.95].round(3)%></td>
			</tr>
	<% end %>
		</table>
</div>
<div id="progress_dialog" style="display:none; background-color:blue; z-index:10">
	word
</div>

				
<% else %>
<h1>Create a new release	</h1>
<%= link_to "New Release", new_release_path%>
<% end %>

<% if true %>

<script type="text/javascript" charset="utf-8">
function startup()
{
	Resize();
	$('#leftcol').resizable({ 
	    handles: "e",
	    stop: function(e, ui) { 
				$('#rightcol').animate({
					left: $('#leftcol').width(),
					width: $(window).width() - $('#leftcol').width(),
					}, 500);
	    }, 
	});	

	$('.ui-resizable-handle').css('background-color','#ABABAB');
	<% Project.all.each do |project| %>
	$('#taskList<%=project.id%>').sortable({
		axis: "y",
		stop: function(e,ui) {
			$('#order').val( $('#taskList<%=project.id%>').sortable('serialize', {"key":''}));
			$('#task_submit').show();
			
		}
	});
	<% end %>
	$('#task_submit').hide();

     $('a.stopped').hover(function() {
       $('img.stopped',this).addClass('stopped-hover');
     }, function() {
       $('img.stopped',this).removeClass('stopped-hover');
     });
  $('.lirow').hover(function(){
		$(this).addClass('lirow-hover');
	}, function(){
		$(this).removeClass('lirow-hover');		
	});
  
}
function updateScroll()
{
	alert('foo')
	//setTimeout("",5);

}
function scrollDiv(lckDiv, scrDiv)
{
	//if (document.getElementById(lckDiv).scrollTop != document.getElementById(scrDiv).scrollTop)
	//{
		document.getElementById(lckDiv).scrollTop = document.getElementById(scrDiv).scrollTop;
	//}
<% if false%>	//document.getElementById(lckDiv).scrollLeft = document.getElementById(scrDiv).scrollLeft;
<% end %>
}

function Resize()
{
	$('#rightcol').css('height',$(window).height() - 36);
	$('#leftcol').css('height',$(window).height() - 36 - 16);
	$('#rightcol').css('width',$(window).width() - 303);	
}
if (window.attachEvent) {
    window.attachEvent("onresize", function() {setTimeout("Resize()",50);} );
} else {
    window.addEventListener("resize", function() {setTimeout("Resize()",50);}, false);
}	
</script>
<% content_for :save_module do %>
	<% remote_form_for :task, :url => reorder_tasks_path, :before => "$('#task_submit').hide();$('#flash').html('Saving Changes & Rebuilding Schedule...')" do |f|%>
	<%= hidden_field_tag :order%>
	<%= f.submit %>
	<% end %>
<% end %>
<% end %>
